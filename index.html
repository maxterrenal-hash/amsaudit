<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AMS Audit</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --muted:#0c1427; --ink:#e5e7eb; --ink-dim:#a7b0be;
    --accent:#22d3ee; --accent-2:#06b6d4; --border:#2a3343; --card:#0b1224; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; color-scheme:dark;}
  body{margin:0;font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);
    background: radial-gradient(1200px 700px at 80% -10%, #0e1a33 0%, var(--bg) 55%);} 
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px 80px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .title{font-size:22px;font-weight:700} .sub{color:var(--ink-dim);font-size:12px}
  button{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#0f1b33,#0d162a);
    color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{border-color:transparent;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#04121a;font-weight:700}
  button.ghost{background:transparent}
  .section{background:linear-gradient(180deg,var(--panel),#0c1427);border:1px solid var(--border);border-radius:var(--radius);
    padding:16px;margin:12px 0 18px;box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02)}
  .section h2{margin:0 0 12px;font-size:16px;font-weight:800}
  .grid{display:grid;gap:12px}
  /* Mobile-first: stack; progressively add columns */
  .grid.cols-2,.grid.cols-3,.grid.cols-4,.grid.cols-5{grid-template-columns:1fr}
  @media(min-width:640px){.grid.cols-2{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:860px){.grid.cols-3{grid-template-columns:repeat(3,1fr)} .two-per-row{grid-template-columns:1fr 1fr}}
  @media(min-width:1024px){.grid.cols-4{grid-template-columns:repeat(4,1fr)} .grid.cols-5{grid-template-columns:repeat(5,1fr)}}

  /* Mobile tweaks */
  @media(max-width:639px){
    header{flex-direction:column;align-items:stretch;gap:8px}
    header .title{font-size:18px}
    header .sub{font-size:11px}
    header > div:last-child{display:grid;grid-template-columns:1fr;gap:8px}
    button{width:100%}
  }

  label{display:block;font-size:12px;color:var(--ink-dim);margin:0 0 6px}

  /* Inputs, selects, date pickers: full dark */
  input[type="text"],input[type="number"],input[type="date"],select,textarea{
    width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--border);
    background:linear-gradient(180deg,#0c1427,#0a1222);color:var(--ink);outline:none;font-size:16px;
  }
  input::placeholder, textarea::placeholder{color:#93a0b3}
  input:focus, select:focus, textarea:focus{box-shadow:0 0 0 2px #0ea5bacc}

  /* Make native selects dark + custom arrow */
  select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M5 7l5 5 5-5' stroke='%23a7b0be' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 10px center;padding-right:36px}
  option, optgroup{background-color:#0a1222;color:var(--ink)}
  /* WebKit date picker icon to light */
  input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1) opacity(.85)}

  textarea{min-height:76px;resize:vertical}
  .note{font-size:12px;color:var(--ink-dim)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#0c1a2d;border:1px solid var(--border);color:var(--ink-dim);font-size:12px}
  .accordion{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
  .acc-item{border-top:1px solid var(--border)}
  .acc-head{display:flex;align-items:center;justify-content:space-between;width:100%;background:transparent;border:0;color:var(--ink);padding:16px 16px;cursor:pointer;text-align:left;font-size:16px}
  .acc-head .name{font-weight:700}
  .acc-body{padding:14px;display:none}.acc-item.open .acc-body{display:block}
  .pill{padding:4px 8px;border-radius:999px;background:#0c1a2d;border:1px solid var(--border);font-size:11px}
  .two-per-row{display:grid;gap:12px} @media(min-width:860px){.two-per-row{grid-template-columns:1fr 1fr}}
  .req::after{content:" *";color:#ef4444}
  .divider{height:1px;background:var(--border);margin:8px 0 16px}
  .tag{font-size:11px;color:#06121c;background:var(--accent);border-radius:8px;padding:2px 8px;font-weight:700}
  .hidden{display:none !important}
  .hint{font-size:11px;color:var(--ink-dim)}
  .tests{margin-top:12px;font-size:12px;color:var(--ink-dim)}
  /* Make Antimicrobial Row 4 auto-fill full width and reflow when a cell is hidden */
  .grid.abx-row4{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  @media(max-width:639px){.grid.abx-row4{grid-template-columns:1fr}}
  /* Make Hospital Number input match dropdown size */
  #hospNo{height:48px}
  /* Make Organism & Notes inputs match dropdown size */
  input[id^="micro_"][id$="_org"],
  input[id^="micro_"][id$="_note"]{height:48px}
  /* Make all date inputs align with dropdowns (width/arrow spacing/height) */
  input[type="date"]{padding-right:36px; min-width:0; height:48px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">AMS Audit</div>
    </div>
    <div>
      <button class="ghost" id="btnReset">Reset</button>
      <button class="primary" id="btnSubmit">Submit</button>
    </div>
  </header>

  <!-- Audit Header -->
  <section class="section">
    <h2>Audit Information</h2>
    <div class="grid cols-2">
      <div>
        <label class="req">Auditor</label>
        <select id="auditor">
          <option value="">Select</option>
          <option>Max</option>
          <option>Micha</option>
          <option>Miko</option>
          <option>Belle</option>
          <option>Michael</option>
        </select>
      </div>
      <div>
        <label class="req">Area</label>
        <select id="area"></select>
      </div>
    </div>
    <div class="grid cols-2" style="margin-top:12px">
      <div>
        <label class="req">Date</label>
        <input id="date" type="date">
      </div>
      <div>
        <label class="req">Shift</label>
        <select id="shift">
          <option value="">Select</option>
          <option>6 to 2</option>
          <option>2 to 10</option>
          <option>10 to 6</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Patient Information -->
  <section class="section">
    <h2>Patient Information</h2>
    <div class="grid cols-4">
      <div><label class="req">Hospital Number</label><input id="hospNo" placeholder="e.g. 23-001234"></div>
      <div><label>Age (Years) <span class="hint">≥ 2 years</span></label><input id="ageYears" type="number" min="0" step="1"></div>
      <div><label>Age (Months) <span class="hint">1–23 months</span></label><input id="ageMonths" type="number" min="1" max="23" step="1"></div>
      <div><label>Age (Days) <span class="hint">&lt; 1 month</span></label><input id="ageDays" type="number" min="0" max="30" step="1"></div>
    </div>
  </section>

  <!-- Diagnostics & Biomarkers -->
  <section class="section">
    <h2>Diagnostics & Biomarkers</h2>
    <div class="grid cols-3">
      <div>
        <label class="req">Treatment based on biomarker or WBC?</label>
        <select id="biomarkerYesNo">
          <option value="">Select</option><option>No</option><option>Yes</option>
        </select>
      </div>
      <div>
        <label>Biomarker</label>
        <select id="biomarkerType" disabled>
          <option value="">Select</option><option>CRP</option><option>PCT</option><option>WBC</option><option>Others</option>
        </select>
        <input id="biomarkerTypeOther" class="hidden" placeholder="Specify biomarker">
      </div>
      <div>
        <label>Fluid sample</label>
        <select id="bioSample" disabled>
          <option value="">Select</option><option>Blood</option><option>Urine</option><option>Others</option>
        </select>
        <input id="bioSampleOther" class="hidden" placeholder="Specify sample">
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:12px">
      <div>
        <label class="req">Culture done?</label>
        <select id="cultureDone"><option value="">Select</option><option>No</option><option>Yes</option></select>
      </div>
      <div>
        <label>Specimen</label>
        <select id="cultureType" disabled>
          <option value="">Select</option>
          <option>Blood</option><option>Urine</option><option>Stool</option><option>CSF</option>
          <option>Wound</option><option>Sputum.Bronchial aspirate</option><option>Other</option>
        </select>
        <input id="cultureTypeOther" class="hidden" placeholder="Specify specimen">
      </div>
    </div>
  </section>

  <!-- Antimicrobials -->
  <section class="section">
    <h2>Antimicrobials (up to 5)</h2>
    <div class="accordion" id="abxAccordion"></div>
  </section>

  <!-- Microbiology -->
  <section class="section">
    <h2>Microorganisms & Resistance</h2>
    <div id="microWrap" class="two-per-row"></div>
  </section>

  <!-- History -->
  <section class="section">
    <h2>Recent History</h2>
    <div class="grid cols-2">
      <div>
        <label class="req">Previous hospitalization &lt; 3 months</label>
        <select id="prevHosp"><option value="">Select</option><option>Yes-ICU</option><option>Yes-Other</option><option>No</option><option>Unknown</option></select>
      </div>
      <div>
        <label class="req">Previous antibiotic course &lt; 1 month</label>
        <select id="prevAbx"><option value="">Select</option><option>Yes</option><option>No</option><option>Unknown</option></select>
      </div>
    </div>
  </section>

  <div style="display:flex;gap:8px;justify-content:flex-end">
    <span class="chip">Validates before sending</span>
    <button class="ghost" id="btnPreview">Preview JSON</button>
    <button class="primary" id="btnSubmit2">Submit</button>
  </div>
  <div id="testBadge" class="tests"></div>
</div>

<script>
/* ======== CONFIG ======== */
const BACKEND_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYED_APPS_SCRIPT/exec";

const AREAS = [
  "OBGyne Ward","NICU","PICU","Medicine Ward","Surgery Ward","Dengue Ward","Adult Cohort",
  "Pedia Ward","ICU","6th Floor Ward","7th Floor Ward","Oncology Ward","Infectious Ward"
];

const ANTIMICROBIAL_GROUPS = [
  {
    label:"Restricted / Special Authorization",
    items:[
      "Imipenem","Meropenem","Ertapenem","Doripenem",
      "Aztreonam",
      "Colistin",
      "Linezolid",
      "Vancomycin",
      "Tigecycline",
      "Ceftolozane-Tazobactam",
      "Amphotericin",
      "IV Fluconazole",
      "Antiviral (specify)",
      "Other antifungal (specify)",
      "4th gen Cephalosporin (specify)",
      "3rd gen Cephalosporin (specify)",
      "Fluoroquinolone (specify)",
      "Aminoglycoside (specify)"
    ]
  },
  {
    label:"Commonly Monitored",
    items:[
      "Gentamicin","Amikacin","Clindamycin"
    ]
  }
];

const DIAG_PRIMARY = ["Therapeutic","Prophylaxis","Neonates"];
const DIAG_THERAPEUTIC = {
  "CNS": [], "EYE": [], "ENT": ["ENT","AOM"],
  "RESP": ["LUNG","URTI","Bron","Pneu","COVID-19","TB","CF"],
  "CVS": [], "GI": ["GI","IA","CDIF"], "SSTBJ": ["SST","BJ"],
  "UTI": ["Cys","Pye","ASB"],
  "GUOB": ["OBGY","GUM","Syph"],
  "No defined site.": ["BAC","SEPSIS","Malaria","HIV","PUO","PUO-HO","FN","LYMPH","Sys-DI","Other","UNK","PROK"]
};
const DIAG_PROPH = ["CNS","EYE","ENT","RESP","CVS","GI","SSTBJ","UTI","GUOB","No defined site."];
const DIAG_NEONATES = ["MP-MAT","NEO-MP","CLD"];

// Spelled-out labels (saved as codes)
const INDICATIONS = [
  { code:"CAI", label:"Community-Acquired Infection" },
  { code:"HAI", label:"Healthcare-Associated Infection" },
  { code:"SP",  label:"Surgical Prophylaxis" },
  { code:"MP",  label:"Medical Prophylaxis" },
  { code:"OTH", label:"Others" },
  { code:"UNK", label:"Unknown" }
];
const HAI_TYPES = ["CRBSI","VAP","CAUTI","HAP","CDAD","MDRO"];

const RESISTANCE = ["MRSA","MRCoNS","PNSP","MLS","VRE","ESBL","3GCREB","CRE","ESBL-NF","CR-NF","other MDRO"];

const MISSED_REASONS = ["stock out","could not purchase","patient refused","other reason","multiple reasons","unknown"];

// Dynamic antimicrobial lists per class (per user spec)
const MONITORED_DRUGS = [
  "Imipenem","Meropenem","Ertapenem","Doripenem",
  "Gentamicin","Amikacin",
  "Ciprofloxacin","Levofloxacin","Moxifloxacin",
  "Aztreonam","Ceftolozane-Tazobactam","Colistin","Linezolid","Tigecycline","Vancomycin","Cefepime"
];
const RESTRICTED_DRUGS = [
  "Ciprofloxacin","Levofloxacin","Moxifloxacin",
  "Ceftriaxone","Cefotaxime","Ceftazidime","Cefixime","Cefpodoxime",
  "Gentamicin","Amikacin","Clindamycin"
];
function refillDrugOptions(selectEl, list){
  if(!selectEl) return;
  selectEl.innerHTML = "";
  selectEl.appendChild(el("option",{value:""},[document.createTextNode("Select antimicrobial")]));
  (list||[]).forEach(name=> selectEl.appendChild(el("option",{value:name},[document.createTextNode(name)])));
}


/* ======== Helpers ======== */
const $ = s => document.querySelector(s);
function el(tag, attrs, kids){
  const n = document.createElement(tag);
  if (attrs && (Array.isArray(attrs) || attrs instanceof Node || typeof attrs === 'string')) {
    kids = attrs; attrs = {};
  }
  attrs = attrs || {};
  for (const [k,v] of Object.entries(attrs)){
    if (k === 'class') n.className = v; 
    else if (k === 'html') n.innerHTML = v; 
    else if (v !== undefined && v !== null) n.setAttribute(k, String(v));
  }
  if (kids !== undefined && kids !== null){
    (Array.isArray(kids) ? kids : [kids]).forEach(ch => {
      if (ch === null || ch === undefined) return;
      n.appendChild(ch instanceof Node ? ch : document.createTextNode(String(ch)));
    });
  }
  return n;
}
const today = ()=> new Date().toISOString().slice(0,10);

/* ======== UI builders ======== */
function buildAreaList(){
  const s = $("#area"); s.innerHTML="";
  s.appendChild(el("option",{value:""},[document.createTextNode("Select")]));
  AREAS.forEach(a=> s.appendChild(el("option",{value:a},[document.createTextNode(a)])));
}

function buildAntimicrobialSelect(idBase){
  const s = el("select",{id:`${idBase}_drug`});
  s.appendChild(el("option",{value:""},[document.createTextNode("Select antimicrobial")]));
  ANTIMICROBIAL_GROUPS.forEach(gr=>{
    const og = el("optgroup",{label:gr.label});
    gr.items.forEach(x=> og.appendChild(el("option",{value:x},[document.createTextNode(x)])));
    s.appendChild(og);
  });
  const wrap = el("div");
  const txt = el("input",{id:`${idBase}_drugSpecify`, class:"hidden", placeholder:"Specify exact drug (e.g., Cefepime, Levofloxacin)"});
  s.addEventListener("change", ()=>{
    const show = /\(specify\)$/i.test(s.value);
    txt.classList.toggle("hidden", !show);
  });
  wrap.appendChild(s); wrap.appendChild(txt);
  return wrap;
}

function buildMissedReasonDropdown(idBase){
  const s = el("select",{id:`${idBase}_missedReason`});
  s.appendChild(el("option",{value:""},[document.createTextNode("Select")]));
  MISSED_REASONS.forEach(r=> s.appendChild(el("option",{value:r},[document.createTextNode(r)])));
  return s;
}

function buildAntimicrobialCard(idx){
  const item = el("div",{class:"acc-item"+(idx===0?" open":"")});
  const head = el("button",{class:"acc-head", type:"button"});
  head.append(
    el("span",{class:"name"},[document.createTextNode(`Antimicrobial ${idx+1}`)]),
    el("span",{class:"pill"},[document.createTextNode(idx===0?"Expanded":"Collapsed")])
  );
  head.addEventListener("click", ()=> item.classList.toggle("open"));
  const body = el("div",{class:"acc-body"});

  // Row 1: Class, Drug, Start date
  const row1 = el("div",{class:"grid cols-3"});
  const cellClass = el("div");
  cellClass.append(
    el("label",{class:"req"},[document.createTextNode("Monitored or Restricted")]),
    (()=>{const s=el("select",{id:`abx_${idx}_class`});
      ["","Monitored","Restricted"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );

  const cellDrug = el("div");
  cellDrug.append(
    el("label",{class:"req"},[document.createTextNode("Antimicrobial")]),
    buildAntimicrobialSelect(`abx_${idx}`)
  );
  // Wire class -> antimicrobial options (runtime refill)
  try{
    const classSel = cellClass.querySelector('select');
    const drugSel  = cellDrug.querySelector(`#abx_${idx}_drug`);
    const drugSpec = cellDrug.querySelector(`#abx_${idx}_drugSpecify`);
    if(classSel && drugSel){
      const onCls = ()=>{
        if(classSel.value === 'Monitored') refillDrugOptions(drugSel, MONITORED_DRUGS);
        else if(classSel.value === 'Restricted') refillDrugOptions(drugSel, RESTRICTED_DRUGS);
        else refillDrugOptions(drugSel, []);
        if(drugSpec){ drugSpec.classList.add('hidden'); drugSpec.value=''; }
      };
      classSel.addEventListener('change', onCls);
      setTimeout(onCls, 0);
    }
  }catch(e){ console.warn('Wiring class->drug failed', e); }
  const cellStart= el("div");
  cellStart.append(
    el("label",{class:"req"},[document.createTextNode("Start date")]),
    el("input",{id:`abx_${idx}_start`,type:"date"})
  );

  // Row 2: Single Unit Dose, Unit, Doses/day, Route
  const row2 = el("div",{class:"grid cols-4", style:"margin-top:12px"});
  const cellDose = el("div");
  cellDose.append(
    el("label",{class:"req"},[document.createTextNode("Single Unit Dose")]),
    el("input",{id:`abx_${idx}_dose`,type:"number",min:"0",step:"0.001"})
  );
  const cellUnit = el("div");
  cellUnit.append(
    el("label",{class:"req"},[document.createTextNode("Unit")]),
    (()=>{const s=el("select",{id:`abx_${idx}_unit`});
      ["","g","mg","IU","MU"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );
  const cellPerDay = el("div");
  cellPerDay.append(
    el("label",{class:"req"},[document.createTextNode("Doses/day")]),
    el("input",{id:`abx_${idx}_perday`,type:"number",min:"0",step:"1"})
  );
  const cellRoute = el("div");
  cellRoute.append(
    el("label",{class:"req"},[document.createTextNode("Route")]),
    (()=>{const s=el("select",{id:`abx_${idx}_route`});
      ["","IM","IV","O","R"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );

  // Row 3: Diagnosis, System/Site, Sub-site/Specific
  const diagTop = el("div",{class:"grid cols-3", style:"margin-top:12px"});
  const diag1 = el("div");
  diag1.append(
    el("label",{class:"req"},[document.createTextNode("Diagnosis")]),
    (()=>{const s=el("select",{id:`abx_${idx}_diagPrimary`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")])); DIAG_PRIMARY.forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v)])));
      s.addEventListener("change",()=>updateDiagSecondary(idx)); return s;})()
  );
  const diagSys = el("div"); diagSys.append(el("label",{},[document.createTextNode("System / Site")]), (()=>{const s=el("select",{id:`abx_${idx}_diagSystem`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")])); s.disabled=true; return s;})())
  const diagSub = el("div"); diagSub.append(el("label",{},[document.createTextNode("Sub-site / Specific")]), (()=>{const s=el("select",{id:`abx_${idx}_diagSub`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")])); s.disabled=true; return s;})())
  
  // Row 4: Type of Indication, Reason in note?, Guidelines Compliance + Stop/Review documented
  const row4 = el("div",{class:"grid abx-row4", style:"margin-top:12px"});
  const cellInd = el("div");
  cellInd.append(
    el("label",{class:"req"},[document.createTextNode("Type of Indication")]),
    (()=>{const s=el("select",{id:`abx_${idx}_indication`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")]));
      INDICATIONS.forEach(({code,label})=>s.appendChild(el("option",{value:code},[document.createTextNode(label)])));
      s.addEventListener("change",()=>toggleHAI(idx)); return s;})()
  );
  const cellHai = el("div",{id:`abx_${idx}_haiWrap`, class:"hidden"});
  cellHai.append(
    el("label",{},[document.createTextNode("HAI subtype")]),
    (()=>{const s=el("select",{id:`abx_${idx}_haiType`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")])); HAI_TYPES.forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v)]))); return s;})()
  );
  const cellReasonNote = el("div");
  cellReasonNote.append(
    el("label",{class:"req"},[document.createTextNode("Reason in note?")]),
    (()=>{const s=el("select",{id:`abx_${idx}_reasonNote`});
      ["","Yes","No"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );
  const cellGuide = el("div");
  cellGuide.append(
    el("label",{class:"req"},[document.createTextNode("Guidelines Compliance")]),
    (()=>{const s=el("select",{id:`abx_${idx}_guide`});
      ["","Yes","No","No Local Guidelines","No information"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );
  // NEW: Stop/Review Date Documented? moved to Row 4
  const cellStopDoc = el("div");
  cellStopDoc.append(
    el("label",{class:"req"},[document.createTextNode("Stop/Review Date Documented?")]),
    (()=>{const s=el("select",{id:`abx_${idx}_stopdoc`});
      ["","Yes","No"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );

  // Row 5: Missed doses (N + Reason), Treatment
  const row5 = el("div",{class:"grid cols-3", style:"margin-top:12px"});
  // Group: N missed dose + Reason (visually related)
  const missWrap = el("div",{style:"grid-column: span 2;"});
  missWrap.append(
    el("label",{},[document.createTextNode("Missed doses")]),
    (()=>{
      const inner = el("div",{class:"grid cols-2"});
      const n = el("div"); n.append(el("label",{},[document.createTextNode("N missed dose")]), el("input",{id:`abx_${idx}_missed`,type:"number",min:"0",step:"1",value:"0"}));
      const r = el("div"); r.append(el("label",{},[document.createTextNode("Reason")]), buildMissedReasonDropdown(`abx_${idx}`));
      inner.append(n,r);
      // enable/disable reason based on N
      setTimeout(()=>{
        const num = inner.querySelector(`#abx_${idx}_missed`);
        const sel = inner.querySelector(`#abx_${idx}_missedReason`);
        const toggle = ()=>{ const v = Number(num.value||0); sel.disabled = v<=0; if(v<=0) sel.value=""; };
        num.addEventListener('input', toggle); toggle();
      });
      return inner;
    })()
  );

  const cellTreat = el("div");
  cellTreat.append(
    el("label",{class:"req"},[document.createTextNode("Treatment")]),
    (()=>{const s=el("select",{id:`abx_${idx}_treat`});
      ["","Empirical","Targeted"].forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v||"Select")]))) ;
      return s;})()
  );

  row1.append(cellClass,cellDrug,cellStart);
  row2.append(cellDose,cellUnit,cellPerDay,cellRoute);
  diagTop.append(diag1,diagSys,diagSub);
  row4.append(cellInd,cellHai,cellReasonNote,cellGuide,cellStopDoc);
  row5.append(missWrap,cellTreat);

  body.append(row1,row2,diagTop,row4,row5);
  item.append(head,body);
  return item;
}

function buildMicroCard(i){
  const card = el("div",{class:"section",style:"margin:0"});
  const hdr = el("div",{style:"display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"});
  hdr.append(el("div",{class:"tag"},[document.createTextNode(`Microorganism ${i+1}`)]));
  const g = el("div",{class:"grid cols-3"});
  const org = el("div"); org.append(el("label",{},[document.createTextNode("Organism")]), el("input",{id:`micro_${i}_org`,placeholder:"e.g. E. coli"}));
  const res = el("div"); res.append(el("label",{},[document.createTextNode("Resistance type")]),
    (()=>{const s=el("select",{id:`micro_${i}_res`}); s.appendChild(el("option",{value:""},[document.createTextNode("Select")])); RESISTANCE.forEach(v=>s.appendChild(el("option",{value:v},[document.createTextNode(v)]))); return s;})()
  );
  const note = el("div"); note.append(el("label",{},[document.createTextNode("Notes")]), el("input",{id:`micro_${i}_note`,placeholder:"Optional"}));
  g.append(org,res,note); card.append(hdr,g); return card;
}

/* ======== Diagnosis logic ======== */
function updateDiagSecondary(idx){
  const p = $(`#abx_${idx}_diagPrimary`).value;
  const sys = $(`#abx_${idx}_diagSystem`);
  const sub = $(`#abx_${idx}_diagSub`);
  sys.innerHTML=""; sub.innerHTML="";
  const add = (sel, arr)=>{ sel.appendChild(el("option",{value:""},[document.createTextNode("Select")])); arr.forEach(v=>sel.appendChild(el("option",{value:v},[document.createTextNode(v)]))); };
  if(p==="Therapeutic"){ add(sys, Object.keys(DIAG_THERAPEUTIC)); sub.disabled=false; sys.disabled=false; sys.onchange=()=>{ sub.innerHTML=""; add(sub, DIAG_THERAPEUTIC[sys.value]||[] ); }; }
  else if(p==="Prophylaxis"){ add(sys, DIAG_PROPH); sub.innerHTML=""; sub.appendChild(el("option",{value:""},[document.createTextNode("Select")])); sub.disabled=true; sys.disabled=false; }
  else if(p==="Neonates"){ add(sys, DIAG_NEONATES); sub.innerHTML=""; sub.appendChild(el("option",{value:""},[document.createTextNode("Select")])); sub.disabled=true; sys.disabled=false; }
  else { ["diagSystem","diagSub"].forEach(k=>{const d=$(`#abx_${idx}_${k}`); d.innerHTML=""; d.appendChild(el("option",{value:""},[document.createTextNode("Select")])); d.disabled=true;}); }
}

function toggleHAI(idx){
  const val = $(`#abx_${idx}_indication`).value;
  $(`#abx_${idx}_haiWrap`).classList.toggle("hidden", val!=="HAI");
}

/* ======== Init ======== */
(function init(){
  buildAreaList();
  $("#date").value = today();

  // Biomarker controls
  $("#biomarkerYesNo").addEventListener("change", e=>{
    const on = e.target.value==="Yes";
    ["#biomarkerType","#bioSample"].forEach(sel=> $(sel).disabled = !on);
    $("#biomarkerTypeOther").classList.toggle("hidden", !(on && $("#biomarkerType").value==="Others"));
    $("#bioSampleOther").classList.toggle("hidden", !(on && $("#bioSample").value==="Others"));
  });
  $("#biomarkerType").addEventListener("change", e=>{
    $("#biomarkerTypeOther").classList.toggle("hidden", e.target.value!=="Others");
  });
  $("#bioSample").addEventListener("change", e=>{
    $("#bioSampleOther").classList.toggle("hidden", e.target.value!=="Others");
  });

  // Culture controls
  $("#cultureDone").addEventListener("change", e=>{
    const on = e.target.value==="Yes";
    $("#cultureType").disabled = !on;
    $("#cultureTypeOther").classList.toggle("hidden", !(on && $("#cultureType").value==="Other"));
  });
  $("#cultureType").addEventListener("change", e=>{
    $("#cultureTypeOther").classList.toggle("hidden", e.target.value!=="Other");
  });

  // Antimicrobial accordion
  const acc = $("#abxAccordion");
  for(let i=0;i<5;i++) acc.appendChild(buildAntimicrobialCard(i));

  // Micro organisms
  const micro = $("#microWrap");
  for(let i=0;i<3;i++) micro.appendChild(buildMicroCard(i));

  // Buttons
  $("#btnReset").addEventListener("click", ()=>{ if(confirm("Clear all fields?")) location.reload(); });
  ["#btnSubmit","#btnSubmit2"].forEach(sel=> $(sel).addEventListener("click", submitForm));
  $("#btnPreview").addEventListener("click", previewJSON);

  runTests();
})();

/* ======== Validation & Payload ======== */
function err(m){ alert(m); }

function collectAndValidate(){
  const header = {
    auditor: $("#auditor").value.trim(),
    area: $("#area").value,
    date: $("#date").value,
    shift: $("#shift").value
  };
  if(!header.auditor) return err("Auditor is required."), null;
  if(!header.area) return err("Area is required."), null;
  if(!header.date) return err("Date is required."), null;
  if(!header.shift) return err("Shift is required."), null;

  // Age exclusivity
  const ay = $("#ageYears").value, am = $("#ageMonths").value, ad = $("#ageDays").value;
  const ageFilled = [ay,am,ad].filter(x=> String(x).trim()!=="").length;
  if(ageFilled!==1) return err("Provide age in Years OR Months OR Days (exactly one)."), null;
  const age = { years: ay? Number(ay): null, months: am? Number(am): null, days: ad? Number(ad): null };
  if(age.years!==null && age.years<2) return err("Years is for ≥ 2 years only."), null;
  if(age.months!==null && (age.months<1 || age.months>23)) return err("Months must be 1–23."), null;
  if(age.days!==null && (age.days<0 || age.days>30)) return err("Days must be 0–30."), null;

  // Biomarker
  const biomarkerBased = $("#biomarkerYesNo").value || "No";
  const biomarkerType = $("#biomarkerType").disabled ? "" : $("#biomarkerType").value;
  const biomarkerTypeOther = (!$("#biomarkerType").disabled && $("#biomarkerType").value==="Others") ? $("#biomarkerTypeOther").value.trim() : "";
  const bioSample = $("#bioSample").disabled ? "" : $("#bioSample").value;
  const bioSampleOther = (!$("#bioSample").disabled && $("#bioSample").value==="Others") ? $("#bioSampleOther").value.trim() : "";
  if(biomarkerBased==="Yes" && !biomarkerType) return err("Specify biomarker type."), null;
  if(biomarkerBased==="Yes" && !bioSample) return err("Specify biological sample."), null;

  // Culture
  const cultureDone = $("#cultureDone").value || "";
  const cultureType = $("#cultureType").disabled ? "" : $("#cultureType").value;
  const cultureTypeOther = (!$("#cultureType").disabled && $("#cultureType").value==="Other") ? $("#cultureTypeOther").value.trim() : "";
  if(cultureDone==="Yes" && !cultureType) return err("Select culture specimen type."), null;

  // Antimicrobials
  const antimicrobials = [];
  for(let i=0;i<5;i++){
    const cls = $(`#abx_${i}_class`).value;
    const drugSel = $(`#abx_${i}_drug`);
    const drug = drugSel ? drugSel.value : "";
    const drugSpecify = $(`#abx_${i}_drugSpecify`)?.value.trim() || "";
    const start = $(`#abx_${i}_start`).value;
    const dose = $(`#abx_${i}_dose`).value;
    const unit = $(`#abx_${i}_unit`).value;
    const perday = $(`#abx_${i}_perday`).value;
    const route = $(`#abx_${i}_route`).value;
    const diagP = $(`#abx_${i}_diagPrimary`).value;
    const diagS = $(`#abx_${i}_diagSystem`).value;
    const diagSub = $(`#abx_${i}_diagSub`).value;
    const indic = $(`#abx_${i}_indication`).value; // code (e.g., CAI)
    const haiType = $(`#abx_${i}_haiType`).value;
    const reasonNote = $(`#abx_${i}_reasonNote`).value;
    const guide = $(`#abx_${i}_guide`).value;
    const stopdoc = $(`#abx_${i}_stopdoc`).value;
    const missed = $(`#abx_${i}_missed`).value || "0";
    const missedReason = $(`#abx_${i}_missedReason`).value || "";
    const treat = $(`#abx_${i}_treat`).value;

    const any = [drug, start, dose, unit, perday, route, diagP, indic, treat].some(v=> (v??"") !== "");
    if(!any) continue;

    if(!cls) return err(`Antimicrobial ${i+1}: select Monitored/Restricted.`), null;
    if(!drug) return err(`Antimicrobial ${i+1}: select drug.`), null;
    if(/\(specify\)$/i.test(drug) && false) return err(`Antimicrobial ${i+1}: specify exact agent for "${drug}".`), null;
    if(!start) return err(`Antimicrobial ${i+1}: start date is required.`), null;
    if(!dose || Number(dose)<=0) return err(`Antimicrobial ${i+1}: enter positive unit dose.`), null;
    if(!unit) return err(`Antimicrobial ${i+1}: select dose unit.`), null;
    if(!perday || Number(perday)<=0) return err(`Antimicrobial ${i+1}: doses/day must be > 0.`), null;
    if(!route) return err(`Antimicrobial ${i+1}: select route.`), null;
    if(!diagP) return err(`Antimicrobial ${i+1}: diagnosis required.`), null;
    if(diagP==="Therapeutic" && !diagS) return err(`Antimicrobial ${i+1}: select system/site.`), null;
    if(diagP==="Therapeutic" && (DIAG_THERAPEUTIC[diagS]||[]).length && !diagSub) return err(`Antimicrobial ${i+1}: select sub-site.`), null;
    if(!indic) return err(`Antimicrobial ${i+1}: indication type required.`), null;
    if(indic==="HAI" && !haiType) return err(`Antimicrobial ${i+1}: choose HAI subtype.`), null;
    if(!reasonNote) return err(`Antimicrobial ${i+1}: Reason in note required.`), null;
    if(!guide) return err(`Antimicrobial ${i+1}: Guidelines Compliance required.`), null;
    if(!treat) return err(`Antimicrobial ${i+1}: Treatment (Empirical/Targeted) required.`), null;
    if(Number(missed)>0 && !missedReason) return err(`Antimicrobial ${i+1}: select reason for missed doses.`), null;

    antimicrobials.push({
      class: cls,
      drug,
      drugSpecify: /\(specify\)$/i.test(drug) ? drugSpecify : "",
      startDate: start,
      unitDose: Number(dose),
      unit, dosesPerDay: Number(perday), route,
      diagnosis: { primary: diagP, system: diagS || "", sub: diagSub || "" },
      indication: indic, // saved as code (e.g., CAI)
      haiSubtype: indic==="HAI" ? haiType : "",
      reasonInNote: reasonNote,
      guidelinesCompliance: guide,
      stopReview: { documented: stopdoc || "" },
      missedDoses: Number(missed),
      missedReason,
      treatment: treat
    });
  }
  if(antimicrobials.length===0) return err("Enter at least one antimicrobial card."), null;

  // Microorganisms (optional)
  const microorganisms = [];
  for(let i=0;i<3;i++){
    const org = $(`#micro_${i}_org`).value.trim();
    const res = $(`#micro_${i}_res`).value;
    const note = $(`#micro_${i}_note`).value.trim();
    if(org || res || note) microorganisms.push({ organism: org, resistance: res, note });
  }

  return {
    formType: "AMS Audit",
    header,
    patient: { hospitalNumber: $("#hospNo").value.trim(), age },
    diagnostics: {
      biomarker: { based: biomarkerBased, type: biomarkerType, typeOther: biomarkerTypeOther, sample: bioSample, sampleOther: bioSampleOther },
      culture: { done: cultureDone, specimen: cultureType, specimenOther: cultureTypeOther }
    },
    antimicrobials,
    microorganisms,
    history: { prevHospitalization3mo: $("#prevHosp").value || "", prevAntibiotic1mo: $("#prevAbx").value || "" },
    meta: { timestamp: new Date().toISOString() }
  };
}

function previewJSON(){
  const payload = collectAndValidate(); if(!payload) return;
  const w = window.open("", "_blank");
  w.document.write("<pre style='padding:16px;color:#e5e7eb;background:#0b1224;'>"+String(JSON.stringify(payload,null,2)).replace(/[<>&]/g,s=>({"<":"&lt;",
  ">":"&gt;","&":"&amp;"}[s]))+"</pre>");
}

async function submitForm(){
  const payload = collectAndValidate(); if(!payload) return;
  if(!/^https:\/\/script\.google\.com\/macros\/s\//.test(BACKEND_URL)) return alert("Set BACKEND_URL to your deployed Apps Script URL first.");
  try{
    const res = await fetch(BACKEND_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const text = await res.text();
    let msg="Submitted."; try{const j=JSON.parse(text); if(j.message) msg=j.message;}catch{}
    alert(msg);
  }catch(e){ console.error(e); alert("Submission failed. Check network/CORS/Apps Script logs."); }
}

/* ======== Lightweight Self-tests ======== */
function runTests(){
  const results = [];
  try{ const L = el('label',[document.createTextNode('OK')]); results.push('✓ el(tag, [kids]) works'); } catch(e){ results.push('✗ el kids-2arg FAILED: '+e); }
  try{ const frag = document.createDocumentFragment(); frag.appendChild(buildAntimicrobialCard(0)); results.push('✓ buildAntimicrobialCard(0)'); } catch(e){ results.push('✗ buildAntimicrobialCard FAILED: '+e); }
  try{
    const dummy = buildMissedReasonDropdown('x'); if(dummy && dummy.nodeName==='SELECT') results.push('✓ missed reason dropdown'); else results.push('✗ missed reason dropdown');
  }catch(e){ results.push('✗ missed reason test FAILED: '+e); }
  const badge = document.getElementById('testBadge');
  if(badge) badge.textContent = 'Tests: '+results.join('  |  ');
}
</script>
</body>
</html>
